

---
title: "Cvičenie 2: Testovanie autokorelácií, AR(1)"
# subtitle: "Testovanie autokorelácií, AR(1)"
# author: "Anna Hlubinová, FMFI UK"
# date: "2024-09-18"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(echo = TRUE,  warning = FALSE, message = FALSE) 
```


# Inštalácia knižníc v R-ku

Začneme s inštaláciou knižníc potrebných na toto cvičenie. Spustením nasledovného príkazu sa nainštalujú tie z knižníc, ktoré nainštalované nie sú, a zároveň sa aj načítajú.

```{r packages}

# názvy balíkov, ktoré budú potrebné pre cvičenie 1
packages <- c("quantmod","astsa","plotly")

# inštalácia balíkov, ak nie sú nainštalované
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages],dependencies=TRUE)
}

# načítanie balíkov
invisible(lapply(packages, library, character.only = TRUE))
```
# Opakovanie - základné pojmy

* Čo je biely šum? (stredná hodnota, disperzia, autokovariancia)
* Kedy považujeme proces za stacionárny? (slabá a silná stacionarita)
* Ako je definovaná autokorelačná funkcia?

# Generovanie nezávislých dát

Vygenerujeme dáta - ide o biely šum posunutý o konštantu.

```{r biely}
N <- 250        # pocet dat
set.seed(12345) # aby sme mali rovnake vysledky
x <- rnorm(N, mean = 10, sd = 1) # nezavisle N(10, 1)
```

Zobrazte priebeh vygenerovaných dát

```{r priebeh, echo=FALSE}
plot(1:N,x,type='l')
```

# Testovanie nulovosti autokorelácií - každá samostatne

Časový rad vieme veľmi dobre reprezentovať pomocou autokorelačnej funkcie (ACF).

V jazyku R máme niekoľko možností ako autokorelačnú funkciu vypočítať. Súčasťou základnej syntaxe jazyka R je funkcia `acf`. Zjednodušením tejto funkcie je potom napríklad funkcia `acf1` z balíka `astsa`, ktorá vynecháva lag 1. Ďalšou možnosťou je použiť funkciu `acf2`. Tá bude užitočná neskôr, zatiaľ ju však používať nebudeme.

```{r acf, eval=FALSE}
acf(x = časový rad,
    lag.max = maximálny počet lagov ktorý nás zaujíma,
    type = jedno z c("correlation", "covariance", "partial"),
    plot = TRUE/FALSE podľa toho či chceme vykresliť aj graf, 
    a ďaľšie argumenty)

acf1(series = časový rad, 
     max.lag = maximálny počet lagov ktorý nás zaujíma,
     plot = TRUE/FALSE podľa toho či chceme vykresliť aj graf,
     pacf = TRUE/FALSE podľa toho či chceme autokorelácie (FALSE) alebo parciálne autokorelácie (TRUE),
     a ďaľšie argumenty)
```

Zobrazte odhadnutú autokorelačnú funkciu.
```{r acf graf}
acf(x)
```

Hodnoty autokorelácií vieme dostať pomocou príkazu
```{r test}
acf(x, plot = FALSE)$acf
```

## Otázky

* Akú hypotézu vieme pomocou tohto výstupu testovať pre každú autokoreláciu?
* Kedy sa táto nulová hypotéza zamieta?
* Čo dostávame v našom prípade?

# Testovanie nulovosti autokorelácií - Ljung-Boxov test
Ak nám vyjdú hodnoty autokorelácií na hranici kritickej oblasti pre zamietanie nulovej hypotézy, je dobré pozrieť sa na autokorelácie aj skupinovo, nielen jednotlivo. Vždy pracujeme len s odhadmi skutočných autokorelácií, preto je užitočné testovať nulovosť skupiny prvých autokorelácií. Napríklad, môžeme testovať nulovosť prvých štyroch autokorelácií, teda  $\rho_1=\rho_2=\rho_3=\rho_4=0$.

Na to nám poslúži Ljung-Boxov test, v Rku príkaz `Box.test`.
```{r box,  eval=FALSE}
Box.test(x = testovaný časový rad,
         lag = počet prvých autokorelácií, ktoré chceme testovať, 
        type = jedno z c("Box-Pierce", "Ljung-Box") pričom budeme používať druhý menovaný,
         fitdf = počet parametrov modelu, ktoré sa majú odpočítať (ak x sú reziduá))

```

Argument `fitdf` bude pre nás mať zmysel neskôr, pri modelovaní ARIMA modelov. Slúži na to, že ak testujeme namiesto pôvodného časového radu reziduá z modelu, stupne voľnosti pre chi-kvadrát štatistiku sa zmenia. To zohľadňuje počet parametrov modelu, ktoré sú už v reziduách vysvetlené.

Otestujte nulovosť prvých troch autokorelácií časového radu `x`. 
```{r, echo=FALSE}
  Box.test(x, lag = 3, type = "Ljung-Box")
```
 
## Otázky

* Ako sa vypočíta testovacia štatistika?
* Aké je pravdepodobnostné rozdelenie štatistiky za platnosti nulovej hypotézy $H_0$?
* Pre aké hodnoty testovej štatistiky zamietame hypotézu $H_0$?
* Ako sa určí p-hodnota?
* Čo dostávame v našom prípade?

# Ljung-Boxov test pre viac lagov a grafické znázornenie I. (simulované dáta)

Cieľom je zrekonštruovať grafický výstup na strane 44 (dáta sú generované na strane 43) slajdov z prednášky: (http://www.iam.fmph.uniba.sk/institute/stehlikova/cr23/prednasky/cr01_uvod.pdf)

Keďže cykly sú vo všeobecnosti v R pomalé, zvolíme iný prístup. Využijeme funkciu `sapply` z triedy funkcií `apply`(s v názve označuje zjednodušenie výstupu, v našom prípade na vektor)

## Príklad použitia funkcie sapply
```{r}
# sucet 1^2 + 2^2 + ... + k^2
k <- 1:10
sapply(k, FUN = function(n) sum((1:n)^2))
```

```{r}
# sucet 1^p + 2^p + ... + k^p
k <- 1:10
sapply(k, FUN = function(n, p) sum((1:n)^p), p = 2)
```

## V našom prípade

Použité dáta môžu byť:

* pevne zvolené (analógia prvého vzorového príkladu)
* alebo môžu byť parametrom funkcie FUN (analógia druhého vzorového príkladu)

Oplatí sa nastaviť y-ovú os na interval $(0,1)$, aby bol skript univerzálny pre všetky dáta, aby sa vždy (aj pri vysokých p hodnotách) dala vidieť vyznačená hodnota 0.05, s ktorou p hodnoty porovnávame. Tú vieme do existujúceho grafu dokresliť použítím jedného z príkazov
```{r, eval=FALSE}
# prvý spôsob
abline( h = 0.05, # horizotálna čiara na hodnote h
        lty = "dashed", # prerušovaná čiara ako typ
        col = "red") # farba

# druhý spôsob
abline( a = 0, # sklon priamky
        b = 0.05, # intercept
        lty = "dashed", # prerušovaná čiara
        col = "red") # farba 
```

Dostávame

```{r, echo=FALSE}
# Simulácia dát
set.seed(12345)
N <- 500
x <- rnorm(N)

# Aplikovanie Ljung-Boxovho testu pre rôzne lags
k <- 1:15
p_values <- sapply(k, FUN = function(lag) Box.test(x, lag = lag, type = "Ljung-Box")$p.value)

# Vykreslenie p-hodnôt s y-osou na intervale (0, 1) a vyznačenou hranicou 0.05
plot(k, p_values, type = "p", ylim = c(0, 1), 
     xlab = "Lag", ylab = "P-hodnota",
     main = "Ljung-Box Test - P-hodnoty")
abline(h = 0.05, col = "red", lty = 2)  # Hranica pre p = 0.05

```

# Analýza výnosov akcií

Pomocou knižnice `quantmod` načítame priamo do R-ka ceny akcií a zistíme, či sú korelované alebo nie.

## Načítanie dát o cenách akcií pomocou quantmod

Načítajte (ak treba, aj nainštalujte) knižnicu `quantmod`.
```{r}
library(quantmod)
```
Na získanie cien akcií sa použije funkcia `getSymbols`.
```{r, eval=FALSE}
getSymbols(Symbols = skratka pre danú akciu - dá sa nájsť na finance.yahoo, 
           from = dátum odkedy chceme dáta,
           to = dátum dokedy chceme dáta, 
           auto.assign = TRUE/FALSE podľa toho či chceme vytvoriť dataset s daným názvom rovno)
```
Napríklad:
```{r}
getSymbols("EBAY", from = "2023-01-01", to = "2023-12-31")
```
Pozrime sa, ako vyzerajú naše dáta, ktoré sú uložené v premennej `EBAY`, zobrazíme ich začiatok:
```{r}
head(EBAY)
```

## Jednoduché ukážky funkcií z balíka
```{r}
chartSeries(EBAY)
```

```{r}
chartSeries(EBAY, theme="white")
```

Skúste aj:
```{r}
chartSeries(EBAY, subset="2023-01::2023-16", up.col = "#009E73", dn.col = "#D55E00") # od juna do septembra
```

Funkciou `to.monthly` transformujeme dáta na mesačné a zobrazíme na grafe.

```{r}
EBAY.mesacne <- to.monthly(EBAY)  # mesacne data
EBAY.mesacne                      # vypiseme
chartSeries(EBAY.mesacne)         # graf
```

## Výnosy akcií
Budeme pracovať s výnosmi akcií. Z našich dát `EBAY` budeme potrebovať posledný stĺpec `EBAY.Adjusted`, z ktorého vypočítame výnosy. Budeme pracovať zo spojitými výnosmi, teda denné výnosy sa budú počítať ako logaritmus podielu cien v dvoch po sebe idúcich dňoch. Ekvivalentne - ako rozdiel logaritmov (takto sa dá použiť funkcia `diff` na výpočet diferencií).
```{r}
ceny <- EBAY$EBAY.Adjusted
vynosy <- diff(log(ceny))
head(vynosy) 
# vidime, ze prva hodnota je NA, vymazeme ju
vynosy <- vynosy[-1]
```

Priebeh výnosov:
```{r}
chartSeries(vynosy, theme=chartTheme('white',up.col="#009E73"))
```

## Cvičenie: Testovanie autokorelácií výnosov akcií
Zobrazte odhad ACF. Sú autokorelácie signifikantné? Pomocou Ljung-Boxovho testu testujte hypotézu, že výnosy sú nekorelované (teda že sú súčtom konštanty - priemerný výnos - a bieleho šumu).

Výsledok pre porovnanie:

```{r, echo=FALSE}
# acf(vynosy)

# Aplikovanie Ljung-Boxovho testu pre rôzne lags
k <- 1:15
p_values <- sapply(k, FUN = function(lag) Box.test(vynosy, lag = lag, type = "Ljung-Box")$p.value)

# Vykreslenie p-hodnôt s y-osou na intervale (0, 1) a vyznačenou hranicou 0.05
plot(k, p_values, type = "p", ylim = c(0, 1), 
     xlab = "Lag", ylab = "P-hodnota",
     main = "Ljung-Box Test - P-hodnoty")
abline(h = 0.05, col = "red", lty = 2)  # Hranica pre p = 0.05
```

# AR(1) procesy

V knižnici datasets je viacero zaujímavých časových radov, my sa teraz pozrieme na prietok Nílu:

```{r}
x <- Nile
x
# podrobnejsi popis v helpe: ?Nile
```

```{r, echo=FALSE}
# Plot the time series using plotly
fig <- plot_ly(x = time(Nile), y = as.numeric(Nile), type = 'scatter', mode = 'lines',
               line = list(color = 'black'),
               name = 'Nile Flow')

# Highlight the time range from 1910 to 1960
fig <- fig %>% add_trace(x = time(Nile)[time(Nile) >= 1910 & time(Nile) <= 1960],
                         y = as.numeric(Nile)[time(Nile) >= 1910 & time(Nile) <= 1960],
                         type = 'scatter', mode = 'lines',
                         fill = 'tozeroy', fillcolor = 'rgba(173, 216, 230, 0.3)',
                         line = list(color = 'black'),
                         name = 'Highlighted Period')


# Add titles and labels
fig <- fig %>% layout(title = "Nile River Annual Flow",
                      xaxis = list(title = "Year"),
                      yaxis = list(title = "Annual Flow"),
                      showlegend = TRUE)

# Show the plot
fig
```
Konkrétne sa zameriame na vyznačenú časť tohto časového radu - od roku 1910 do roku 1960. Aby sme získali časť časového radu, použijeme funkciu `window`:

```{r}
x <- window(x, start=1910, end=1960)
```

Našou úlohou bude zistiť, či je AR(1) proces dobrým modelom pre tieto dáta. Budeme modelovať dáta pomocou funkcie sarima, zatiaľ iba so 4 argumentami.

```{r, eval=FALSE}
sarima(xdata = dáta ktoré chceme modelovať,
       p = autoregresný rád,
       d = rád diferencovania,
       q = moving average rád)
```


```{r, echo=FALSE, results='hide'}
sarima(x,1,0,0)
```

## Otázky

* Je AR(1) proces dobrým modelom pre tieto dáta?
* Nestačilo by dáta modelovať bez akýchkoľvek autoregresných členov, t. j. ako konštantu plus biely šum?

# Zapísanie odhadnutého modelu na základe výstupu z R-ka

Vygenerujme si dáta - 100 hodnôt autoregresného procesu $x_t=0.8x_{t−1}+u_t$, kde $D[ut]=2$:

```{r}
set.seed(123)
x <- arima.sim(model=list(ar=c(0.8)), n=100, sd=sqrt(2))
plot(x)
```
 
Odhadneme AR(1) model:

```{r}
sarima(x,1,0,0, details=FALSE)
```

Odhadnutý model je 
$$
x_t = \delta + 0.7930 x_{t-1} + u_t
$$

kde $\delta$ je taká konštanta, aby platilo, že $E[x_t]=0.0204$ (`xmean` z výstupu).

## Úloha
Dopočítajte konštantu $\delta$.

# Teoretický príklad _(str. 36 prednáškových slajdov)_
Nech $z_t$ je proces, ktorého hodnoty sú nezávislé náhodné premenné s rozdelením $N (0,1)$. Ukážte, že nasledujúci proces je stacionárny a vypočítajte jeho ACF:
$$   y_t =
    \begin{cases} 
    z_t, & \text{pre } t \text{ nepárne}, \\
    \frac{1}{\sqrt{2}} \left(z_t^2-1\right), & \text{pre } t \text{ párne}.
    \end{cases}
$$

# Poznámka: R markdown

R markdown bol použitý aj na vytvorenie tejto stránky priamo v R-ku, takisto na vytvorenie slajdov k prednáške. Užitočné odkazy na tvorbu R markdownu/syntax:

* R markdown: http://rmarkdown.rstudio.com/
* Konkrétne HTML dokumenty: https://bookdown.org/yihui/rmarkdown/html-document.html
* Užitočný môže byť aj interaktívny notebook: https://bookdown.org/yihui/rmarkdown/notebook.htm
